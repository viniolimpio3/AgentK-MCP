services:
  # Servidor MCP AgentK
  agentk-server:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: agentk-mcp-server
    ports:
      - "3333:3333"
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED:-1}
      - FASTMCP_HOST=${FASTMCP_HOST:-0.0.0.0}
      - FASTMCP_PORT=${FASTMCP_PORT:-3333}
      - FASTMCP_LOG_LEVEL=${FASTMCP_LOG_LEVEL:-INFO}
      - KUBECONFIG=/app/config
      # Passar variáveis do .env se existirem
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    volumes:
      # Windows (ajuste conforme necessário)
      # - ~/.kube/:/app/.kube/:ro
      # - ~/.minikube:/app/.minikube:ro

      # Linux (comente se estiver usando Windows)
      - ~/.kube/config-embedded:/app/config:ro
    networks:
      - agentk-network
      - minikube
    restart: unless-stopped

  # Cliente Streamlit AgentK
  agentk-client:
    build:
      context: ./client
      dockerfile: Dockerfile
    container_name: agentk-streamlit-client
    ports:
      - "8501:8501"
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED:-1}
      - STREAMLIT_SERVER_HEADLESS=${STREAMLIT_SERVER_HEADLESS:-true}
      - STREAMLIT_SERVER_ENABLE_CORS=${STREAMLIT_SERVER_ENABLE_CORS:-false}
      # Variável para conectar ao servidor MCP via HTTP
      - MCP_SERVER_URL=${MCP_SERVER_URL:-http://agentk-server:3333}
      # Chave da OpenAI (OBRIGATÓRIA - deve estar no .env)
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    networks:
      - agentk-network
    depends_on:
      agentk-server:
        condition: service_healthy
    restart: unless-stopped

networks:
  agentk-network:
    driver: bridge
    name: agentk-network
  minikube:
    external: true
    name: minikube

volumes:
  agentk-logs:
    driver: local